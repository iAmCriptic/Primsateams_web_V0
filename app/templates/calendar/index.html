{% extends "base.html" %}

{% block title %}Termine - Team Portal{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col">
        <h1><i class="bi bi-calendar-event"></i> Termine</h1>
    </div>
    <div class="col-auto">
        <div class="btn-group me-3 mb-2" role="group">
            <button type="button" class="btn btn-accent active" id="monthViewBtn">
                <i class="bi bi-calendar-month"></i> <span class="d-none d-md-inline">Monatsansicht</span>
            </button>
            <button type="button" class="btn btn-outline-accent" id="weekViewBtn">
                <i class="bi bi-calendar-week"></i> <span class="d-none d-md-inline">Wochenansicht</span>
            </button>
            <button type="button" class="btn btn-outline-accent" id="dayViewBtn">
                <i class="bi bi-calendar-day"></i> <span class="d-none d-md-inline">Tagesansicht</span>
            </button>
            <button type="button" class="btn btn-outline-accent" id="listViewBtn">
                <i class="bi bi-list-ul"></i> <span class="d-none d-md-inline">Terminübersicht</span>
            </button>
        </div>
        <div class="btn-group me-2 mb-2" role="group">
            <a href="{{ url_for('calendar.create_event') }}" class="btn btn-accent">
                <i class="bi bi-plus-circle"></i> <span class="d-none d-md-inline">Neuer Termin</span>
            </a>
            <button type="button" class="btn btn-accent dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="visually-hidden">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="{{ url_for('calendar.export_calendar') }}"><i class="bi bi-download"></i> Kalender exportieren</a></li>
                <li><a class="dropdown-item" href="{{ url_for('calendar.import_calendar') }}"><i class="bi bi-upload"></i> Kalender importieren</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{{ url_for('calendar.manage_feeds') }}"><i class="bi bi-share"></i> Öffentliche Kalender verwalten</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Monatsansicht -->
<div id="monthView" class="calendar-view">
    <div class="row mb-3">
        <div class="col-auto">
            <button class="btn btn-outline-secondary" id="prevMonth">
                <i class="bi bi-chevron-left"></i>
            </button>
        </div>
        <div class="col text-center">
            <h3 id="currentMonth">{{ current_month.strftime('%B %Y') if current_month else 'Oktober 2025' }}</h3>
        </div>
        <div class="col-auto">
            <button class="btn btn-outline-secondary" id="nextMonth">
                <i class="bi bi-chevron-right"></i>
            </button>
        </div>
    </div>
    
    <div class="calendar-grid">
        <div class="calendar-header">
            <div class="day-header">Mo</div>
            <div class="day-header">Di</div>
            <div class="day-header">Mi</div>
            <div class="day-header">Do</div>
            <div class="day-header">Fr</div>
            <div class="day-header">Sa</div>
            <div class="day-header">So</div>
        </div>
        
        <div class="calendar-body" id="calendarBody">
            <!-- Kalender wird per JavaScript generiert -->
        </div>
    </div>
</div>

<!-- Terminübersicht -->
<div id="listView" class="calendar-view" style="display: none;">
    {% if events %}
    <div class="list-group">
        {% for event in events %}
        <div class="list-group-item list-group-item-action event-list-item">
            <div class="d-flex w-100 justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <h5 class="mb-1">{{ event.title }}</h5>
                    <p class="mb-1">
                        <i class="bi bi-calendar"></i> {{ event.start_time.strftime('%d.%m.%Y') }}
                        <i class="bi bi-clock ms-2"></i> {{ event.start_time.strftime('%H:%M') }} - {{ event.end_time.strftime('%H:%M') }} Uhr
                        {% if event.location %}
                        <i class="bi bi-geo-alt ms-2"></i> {{ event.location }}
                        {% endif %}
                    </p>
                    {% if event.description %}
                    <p class="mb-1 text-muted">{{ event.description }}</p>
                    {% endif %}
                </div>
                <div class="ms-3">
                    {% set participation = participations.get(event.id) %}
                    {% if participation %}
                        {% if participation.status == 'accepted' %}
                        <span class="badge bg-success">Zugesagt</span>
                        {% elif participation.status == 'declined' %}
                        <span class="badge bg-danger">Abgesagt</span>
                        {% elif participation.status == 'removed' %}
                        <span class="badge bg-secondary">Entfernt</span>
                        {% else %}
                        <span class="badge bg-warning">Ausstehend</span>
                        {% endif %}
                    {% endif %}
                    <a href="{{ url_for('calendar.view_event', event_id=event.id) }}" class="btn btn-sm btn-outline-accent ms-2">
                        Details
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i>
        Keine Termine vorhanden. Erstellen Sie den ersten Termin!
    </div>
    {% endif %}
</div>

<!-- Wochenansicht -->
<div id="weekView" class="calendar-view" style="display: none;">
    <div class="row mb-3">
        <div class="col">
            <h4 id="weekTitle">Woche</h4>
        </div>
        <div class="col-auto">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary" id="prevWeekBtn">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <button type="button" class="btn btn-outline-primary" id="todayWeekBtn">Heute</button>
                <button type="button" class="btn btn-outline-primary" id="nextWeekBtn">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
    <div id="weekCalendar"></div>
</div>

<!-- Tagesansicht -->
<div id="dayView" class="calendar-view" style="display: none;">
    <div class="row mb-3">
        <div class="col">
            <h4 id="dayTitle">Tag</h4>
        </div>
        <div class="col-auto">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary" id="prevDayBtn">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <button type="button" class="btn btn-outline-primary" id="todayDayBtn">Heute</button>
                <button type="button" class="btn btn-outline-primary" id="nextDayBtn">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
    <div id="dayCalendar"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // View Toggle
    const monthViewBtn = document.getElementById('monthViewBtn');
    const weekViewBtn = document.getElementById('weekViewBtn');
    const dayViewBtn = document.getElementById('dayViewBtn');
    const listViewBtn = document.getElementById('listViewBtn');
    const monthView = document.getElementById('monthView');
    const weekView = document.getElementById('weekView');
    const dayView = document.getElementById('dayView');
    const listView = document.getElementById('listView');
    
    function switchView(activeView, activeBtn) {
        // Hide all views
        monthView.style.display = 'none';
        weekView.style.display = 'none';
        dayView.style.display = 'none';
        listView.style.display = 'none';
        
        // Remove active class from all buttons
        [monthViewBtn, weekViewBtn, dayViewBtn, listViewBtn].forEach(btn => {
            btn.classList.remove('active', 'btn-accent');
            btn.classList.add('btn-outline-accent');
        });
        
        // Show active view and button
        activeView.style.display = 'block';
        activeBtn.classList.add('active', 'btn-accent');
        activeBtn.classList.remove('btn-outline-accent');
    }
    
    monthViewBtn.addEventListener('click', function() {
        switchView(monthView, monthViewBtn);
        updateCalendar(); // Regenerate calendar when switching back
    });
    
    weekViewBtn.addEventListener('click', function() {
        switchView(weekView, weekViewBtn);
        generateWeekView();
    });
    
    dayViewBtn.addEventListener('click', function() {
        switchView(dayView, dayViewBtn);
        generateDayView();
    });
    
    listViewBtn.addEventListener('click', function() {
        switchView(listView, listViewBtn);
    });
    
    // Calendar Navigation
    let currentDate = new Date();
    const monthNames = [
        'Januar', 'Februar', 'März', 'April', 'Mai', 'Juni',
        'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'
    ];
    
    function updateCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        document.getElementById('currentMonth').textContent = 
            monthNames[month] + ' ' + year;
        
        generateCalendar(year, month);
    }
    
    async function generateCalendar(year, month) {
        const calendarBody = document.getElementById('calendarBody');
        calendarBody.innerHTML = '';
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startDay = (firstDay.getDay() + 6) % 7; // Montag = 0
        
        // Leere Zellen für Tage vor dem ersten Tag des Monats
        for (let i = 0; i < startDay; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'calendar-day empty';
            calendarBody.appendChild(emptyCell);
        }
        
        // Tage des Monats
        for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day';
            dayCell.textContent = day;
            
            // Heute markieren
            const today = new Date();
            if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                dayCell.classList.add('today');
            }
            
            calendarBody.appendChild(dayCell);
        }
        
        // Events für alle Tage laden (einmal für den ganzen Monat)
        await loadEventsForMonth(year, month + 1);
    }
    
    async function loadEventsForMonth(year, month) {
        try {
            const response = await fetch(`/calendar/api/events/${year}/${month}`);
            if (response.ok) {
                const events = await response.json();
                
                // Events zu den entsprechenden Tagen hinzufügen
                events.forEach(event => {
                    const dayCells = document.querySelectorAll('.calendar-day:not(.empty)');
                    dayCells.forEach(dayCell => {
                        if (parseInt(dayCell.textContent) === event.day) {
                            const eventElement = document.createElement('div');
                            eventElement.className = 'calendar-event';
                            
                            // Add status-based styling
                            if (event.participation_status === 'accepted') {
                                eventElement.classList.add('accepted');
                            } else if (event.participation_status === 'declined') {
                                eventElement.classList.add('declined');
                            } else if (event.participation_status === 'removed') {
                                eventElement.classList.add('removed');
                            } else {
                                eventElement.classList.add('pending');
                            }
                            
                            eventElement.textContent = event.title;
                            eventElement.title = `${event.title} - ${event.time}${event.location ? ' - ' + event.location : ''}`;
                            
                            // Make event clickable
                            eventElement.style.cursor = 'pointer';
                            eventElement.addEventListener('click', function() {
                                window.location.href = event.url;
                            });
                            
                            dayCell.appendChild(eventElement);
                        }
                    });
                });
            }
        } catch (error) {
            console.error('Error loading events:', error);
        }
    }
    
    document.getElementById('prevMonth').addEventListener('click', function() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        updateCalendar();
    });
    
    document.getElementById('nextMonth').addEventListener('click', function() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        updateCalendar();
    });
    
    // Initial calendar generation
    updateCalendar();
    
    // Week View Functions
    let currentWeekDate = new Date();
    
    function generateWeekView() {
        const weekCalendar = document.getElementById('weekCalendar');
        const weekTitle = document.getElementById('weekTitle');
        
        // Get start of week (Monday)
        const startOfWeek = new Date(currentWeekDate);
        const day = startOfWeek.getDay();
        const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1);
        startOfWeek.setDate(diff);
        
        // Get end of week (Sunday)
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6);
        
        weekTitle.textContent = `Woche ${startOfWeek.getDate()}.${startOfWeek.getMonth() + 1}. - ${endOfWeek.getDate()}.${endOfWeek.getMonth() + 1}.${endOfWeek.getFullYear()}`;
        
        // Generate week grid
        const days = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];
        const hours = Array.from({length: 24}, (_, i) => i); // 00:00 bis 23:00
        
        let html = '<div class="week-grid">';
        html += '<div class="week-header">';
        html += '<div class="time-column">Zeit</div>';
        
        for (let i = 0; i < 7; i++) {
            const date = new Date(startOfWeek);
            date.setDate(startOfWeek.getDate() + i);
            const isToday = date.toDateString() === new Date().toDateString();
            html += `<div class="day-header ${isToday ? 'today' : ''}">${days[i]}<br><small>${date.getDate()}.${date.getMonth() + 1}</small></div>`;
        }
        html += '</div>';
        
        // Time slots
        for (const hour of hours) {
            html += '<div class="time-row">';
            html += `<div class="time-label">${hour.toString().padStart(2, '0')}:00</div>`;
            
            for (let day = 0; day < 7; day++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + day);
                html += `<div class="time-slot" data-date="${date.toISOString().split('T')[0]}" data-hour="${hour}"></div>`;
            }
            html += '</div>';
        }
        
        html += '</div>';
        weekCalendar.innerHTML = html;
        
        // Load events for the week
        loadWeekEvents(startOfWeek, endOfWeek);
    }
    
    async function loadWeekEvents(startDate, endDate) {
        try {
            const response = await fetch(`/calendar/api/events/range/${startDate.toISOString().split('T')[0]}/${endDate.toISOString().split('T')[0]}`);
            if (response.ok) {
                const events = await response.json();
                events.forEach(event => {
                    const eventDate = new Date(event.start_time).toISOString().split('T')[0];
                    const eventHour = new Date(event.start_time).getHours();
                    const timeSlot = document.querySelector(`[data-date="${eventDate}"][data-hour="${eventHour}"]`);
                    
                    if (timeSlot) {
                        const eventElement = document.createElement('div');
                        eventElement.className = `calendar-event ${event.participation_status || 'pending'}`;
                        eventElement.innerHTML = `
                            <strong>${event.time}</strong><br>
                            ${event.title}
                            ${event.location ? `<br><small><i class="bi bi-geo-alt"></i> ${event.location}</small>` : ''}
                        `;
                        eventElement.onclick = () => window.location.href = event.url;
                        timeSlot.appendChild(eventElement);
                    }
                });
            }
        } catch (error) {
            console.error('Error loading week events:', error);
        }
    }
    
    // Day View Functions
    let currentDayDate = new Date();
    
    function generateDayView() {
        const dayCalendar = document.getElementById('dayCalendar');
        const dayTitle = document.getElementById('dayTitle');
        
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        dayTitle.textContent = currentDayDate.toLocaleDateString('de-DE', options);
        
        // Generate day grid
        const hours = Array.from({length: 24}, (_, i) => i); // 00:00 bis 23:00
        
        let html = '<div class="day-grid">';
        
        for (const hour of hours) {
            html += '<div class="day-time-row">';
            html += `<div class="day-time-label">${hour.toString().padStart(2, '0')}:00</div>`;
            html += `<div class="day-time-slot" data-hour="${hour}"></div>`;
            html += '</div>';
        }
        
        html += '</div>';
        dayCalendar.innerHTML = html;
        
        // Load events for the day
        loadDayEvents(currentDayDate);
    }
    
    async function loadDayEvents(date) {
        try {
            const dateStr = date.toISOString().split('T')[0];
            const response = await fetch(`/calendar/api/events/range/${dateStr}/${dateStr}`);
            if (response.ok) {
                const events = await response.json();
                events.forEach(event => {
                    const eventHour = new Date(event.start_time).getHours();
                    const timeSlot = document.querySelector(`[data-hour="${eventHour}"]`);
                    
                    if (timeSlot) {
                        const eventElement = document.createElement('div');
                        eventElement.className = `calendar-event ${event.participation_status || 'pending'}`;
                        eventElement.innerHTML = `
                            <strong>${event.time}</strong><br>
                            ${event.title}
                            ${event.location ? `<br><small><i class="bi bi-geo-alt"></i> ${event.location}</small>` : ''}
                        `

;
                        eventElement.onclick = () => window.location.href = event.url;
                        timeSlot.appendChild(eventElement);
                    }
                });
            }
        } catch (error) {
            console.error('Error loading day events:', error);
        }
    }
    
    // Week Navigation
    document.getElementById('prevWeekBtn').addEventListener('click', function() {
        currentWeekDate.setDate(currentWeekDate.getDate() - 7);
        generateWeekView();
    });
    
    document.getElementById('nextWeekBtn').addEventListener('click', function() {
        currentWeekDate.setDate(currentWeekDate.getDate() + 7);
        generateWeekView();
    });
    
    document.getElementById('todayWeekBtn').addEventListener('click', function() {
        currentWeekDate = new Date();
        generateWeekView();
    });
    
    // Day Navigation
    document.getElementById('prevDayBtn').addEventListener('click', function() {
        currentDayDate.setDate(currentDayDate.getDate() - 1);
        generateDayView();
    });
    
    document.getElementById('nextDayBtn').addEventListener('click', function() {
        currentDayDate.setDate(currentDayDate.getDate() + 1);
        generateDayView();
    });
    
    document.getElementById('todayDayBtn').addEventListener('click', function() {
        currentDayDate = new Date();
        generateDayView();
    });
});
</script>
{% endblock %}



